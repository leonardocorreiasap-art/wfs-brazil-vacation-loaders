<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Balance Import Generator | WFS Brazil</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [goLiveDate, setGoLiveDate] = useState('2025-08-01');
            const [file, setFile] = useState(null);
            const [data, setData] = useState([]);
            const [stats, setStats] = useState(null);
            const [preview, setPreview] = useState([]);
            const [processing, setProcessing] = useState(false);
            const [includeCarryover, setIncludeCarryover] = useState(false);
            const [includeThirteenth, setIncludeThirteenth] = useState(false);

            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    return new Date(dateStr);
                }
                
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                    const [day, month, year] = dateStr.split('/');
                    return new Date(year, month - 1, day);
                }
                
                return null;
            };

            const formatDateISO = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return year + '-' + month + '-' + day;
            };

            const formatEmployeeId = (id) => {
                return String(id).padStart(4, '0');
            };

            const calculateMonthsWorked = (admissionDate, goLive) => {
                const admission = new Date(admissionDate);
                const today = new Date(goLive);
                
                let periodStart = new Date(admission);
                while (true) {
                    const periodEnd = new Date(periodStart);
                    periodEnd.setFullYear(periodEnd.getFullYear() + 1);
                    periodEnd.setDate(periodEnd.getDate() - 1);
                    
                    if (today >= periodStart && today <= periodEnd) {
                        const monthsInPeriod = (today.getFullYear() - periodStart.getFullYear()) * 12;
                        return monthsInPeriod + (today.getMonth() - periodStart.getMonth());
                    }
                    
                    periodStart = new Date(periodEnd);
                    periodStart.setDate(periodStart.getDate() + 1);
                }
            };

            const calculateBalances = (admissionDate, goLive) => {
                const monthsWorked = calculateMonthsWorked(admissionDate, goLive);
                const accrualBalance = (monthsWorked * 2.5).toFixed(2);
                const entitlementBalance = monthsWorked >= 12 ? "30.00" : "0.00";
                
                return {
                    accrual: accrualBalance,
                    entitlement: entitlementBalance,
                    carryover: "0.00",
                    thirteenth: "1.0"
                };
            };

            const processFile = (fileContent) => {
                setProcessing(true);
                
                try {
                    Papa.parse(fileContent, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const goLive = new Date(goLiveDate);
                            const processed = [];
                            const excluded = {
                                interns: 0,
                                invalidDates: 0,
                                duplicates: 0
                            };
                            const seenIds = new Set();

                            results.data.forEach(row => {
                                const empId = row.EXTERNAL_HR_ID ? row.EXTERNAL_HR_ID.trim() : null;
                                const admissionDateStr = row.LATEST_ASSIGNMENT_BEGIN_DATE ? row.LATEST_ASSIGNMENT_BEGIN_DATE.trim() : null;
                                const policyProfile = row.POLICY_PROFILE ? row.POLICY_PROFILE.trim() : null;

                                if (policyProfile === 'PP7') {
                                    excluded.interns++;
                                    return;
                                }

                                const admissionDate = parseDate(admissionDateStr);
                                if (!admissionDate) {
                                    excluded.invalidDates++;
                                    return;
                                }

                                if (seenIds.has(empId)) {
                                    excluded.duplicates++;
                                    return;
                                }
                                seenIds.add(empId);

                                const balances = calculateBalances(admissionDate, goLive);
                                const formattedEmpId = formatEmployeeId(empId);
                                const asOfDate = formatDateISO(goLive);

                                processed.push({
                                    EMPLOYEE_ID: formattedEmpId,
                                    BANK: 'EXT_BRA_VACATION_ACCRUAL_BANK',
                                    BALANCE: balances.accrual,
                                    AS_OF_DATE: asOfDate
                                });

                                processed.push({
                                    EMPLOYEE_ID: formattedEmpId,
                                    BANK: 'EXT_BRA_VACATION_ENTITLEMENT_BANK',
                                    BALANCE: balances.entitlement,
                                    AS_OF_DATE: asOfDate
                                });

                                if (includeCarryover) {
                                    processed.push({
                                        EMPLOYEE_ID: formattedEmpId,
                                        BANK: 'EXT_BRA_VACATION_CARRYOVER_BANK',
                                        BALANCE: balances.carryover,
                                        AS_OF_DATE: asOfDate
                                    });
                                }

                                if (includeThirteenth) {
                                    processed.push({
                                        EMPLOYEE_ID: formattedEmpId,
                                        BANK: 'EXT_BRA_VACATION_THIRTEENTH_MONTH_ADVANCE_BANK',
                                        BALANCE: balances.thirteenth,
                                        AS_OF_DATE: asOfDate
                                    });
                                }
                            });

                            setData(processed);
                            setPreview(processed.slice(0, 12));
                            setStats({
                                total: processed.length,
                                employees: seenIds.size,
                                excluded
                            });
                            setProcessing(false);
                        },
                        error: (error) => {
                            alert('Erro ao processar arquivo: ' + error.message);
                            setProcessing(false);
                        }
                    });
                } catch (error) {
                    alert('Erro ao processar arquivo: ' + error.message);
                    setProcessing(false);
                }
            };

            const handleFileUpload = (e) => {
                const uploadedFile = e.target.files[0];
                if (uploadedFile) {
                    setFile(uploadedFile);
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        processFile(event.target.result);
                    };
                    reader.onerror = () => {
                        alert('Erro ao ler arquivo');
                        setProcessing(false);
                    };
                    reader.readAsText(uploadedFile);
                }
            };

            const downloadCSV = () => {
                if (data.length === 0) {
                    alert('Nenhum dado para exportar!');
                    return;
                }

                const headers = ['EMPLOYEE_ID', 'BANK', 'BALANCE', 'AS_OF_DATE'];
                const csv = Papa.unparse({
                    fields: headers,
                    data: data.map(row => headers.map(h => row[h]))
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().split('T')[0];
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'BANK_BALANCE_IMPORT_' + timestamp + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-green-50 to-teal-100 p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('div', { className: 'bg-white rounded-lg shadow-lg p-8 mb-8' },
                        React.createElement('h1', { className: 'text-4xl font-bold text-teal-900 mb-2' }, '💰 Bank Balance Import Generator'),
                        React.createElement('p', { className: 'text-gray-600' }, 'Gerador de saldos iniciais para bancos de férias (CLT)')
                    ),
                    
                    React.createElement('div', { className: 'bg-white rounded-lg shadow-lg p-8 mb-8' },
                        React.createElement('h2', { className: 'text-2xl font-bold text-gray-800 mb-4' }, '⚙️ Configuração'),
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '📅 Data de Go-Live'),
                                React.createElement('input', {
                                    type: 'date',
                                    value: goLiveDate,
                                    onChange: (e) => setGoLiveDate(e.target.value),
                                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent'
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '📁 Upload emp_import.csv'),
                                React.createElement('input', {
                                    type: 'file',
                                    accept: '.csv',
                                    onChange: handleFileUpload,
                                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent'
                                })
                            )
                        ),
                        
                        React.createElement('div', { className: 'border-t pt-6' },
                            React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, '🏦 Bancos Opcionais'),
                            React.createElement('div', { className: 'space-y-4' },
                                React.createElement('div', { className: 'bg-yellow-50 border-l-4 border-yellow-400 p-4' },
                                    React.createElement('label', { className: 'flex items-start cursor-pointer' },
                                        React.createElement('input', {
                                            type: 'checkbox',
                                            checked: includeCarryover,
                                            onChange: (e) => setIncludeCarryover(e.target.checked),
                                            className: 'mt-1 mr-3 h-5 w-5'
                                        }),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: 'font-semibold text-gray-800' }, 'EXT_BRA_VACATION_CARRYOVER_BANK'),
                                            React.createElement('div', { className: 'text-sm text-gray-600 mt-1' }, '⚠️ Marque SOMENTE se houver férias vencidas a migrar.')
                                        )
                                    )
                                ),
                                React.createElement('div', { className: 'bg-blue-50 border-l-4 border-blue-400 p-4' },
                                    React.createElement('label', { className: 'flex items-start cursor-pointer' },
                                        React.createElement('input', {
                                            type: 'checkbox',
                                            checked: includeThirteenth,
                                            onChange: (e) => setIncludeThirteenth(e.target.checked),
                                            className: 'mt-1 mr-3 h-5 w-5'
                                        }),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: 'font-semibold text-gray-800' }, 'EXT_BRA_VACATION_THIRTEENTH_MONTH_ADVANCE_BANK'),
                                            React.createElement('div', { className: 'text-sm text-gray-600 mt-1' }, 'ℹ️ Marque se o WFS gerenciará 13º salário.')
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    
                    stats && React.createElement('div', { className: 'bg-white rounded-lg shadow-lg p-8 mb-8' },
                        React.createElement('h2', { className: 'text-2xl font-bold text-gray-800 mb-4' }, '📊 Estatísticas'),
                        React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                            React.createElement('div', { className: 'bg-green-100 p-4 rounded-lg' },
                                React.createElement('div', { className: 'text-3xl font-bold text-green-800' }, stats.total),
                                React.createElement('div', { className: 'text-sm text-green-600' }, 'Registros')
                            ),
                            React.createElement('div', { className: 'bg-blue-100 p-4 rounded-lg' },
                                React.createElement('div', { className: 'text-3xl font-bold text-blue-800' }, stats.employees),
                                React.createElement('div', { className: 'text-sm text-blue-600' }, 'Funcionários')
                            ),
                            React.createElement('div', { className: 'bg-yellow-100 p-4 rounded-lg' },
                                React.createElement('div', { className: 'text-3xl font-bold text-yellow-800' }, stats.excluded.interns),
                                React.createElement('div', { className: 'text-sm text-yellow-600' }, 'Estagiários')
                            ),
                            React.createElement('div', { className: 'bg-red-100 p-4 rounded-lg' },
                                React.createElement('div', { className: 'text-3xl font-bold text-red-800' }, stats.excluded.invalidDates + stats.excluded.duplicates),
                                React.createElement('div', { className: 'text-sm text-red-600' }, 'Excluídos')
                            )
                        )
                    ),
                    
                    data.length > 0 && React.createElement('div', { className: 'bg-white rounded-lg shadow-lg p-8 text-center' },
                        React.createElement('button', {
                            onClick: downloadCSV,
                            className: 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg text-lg'
                        }, '⬇️ Baixar CSV (' + data.length + ' registros)')
                    )
                )
            );
        }

        // Aguardar carregamento completo
        if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined' && typeof Papa !== 'undefined') {
            ReactDOM.render(React.createElement(App), document.getElementById('root'));
        } else {
            document.getElementById('root').innerHTML = '<div style="padding: 50px; text-align: center; color: red;">Erro ao carregar bibliotecas. Recarregue a página.</div>';
        }
    </script>
</body>
</html>
